<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Seguimiento Movil</title>

    <link rel="stylesheet" href="http://js.arcgis.com/3.11/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.11/esri/css/esri.css">
    <link href="Content/bootstrap-theme.css" rel="stylesheet" />
    <link href="Content/bootstrap.css" rel="stylesheet" />
    <style>
      html, body { 
        height: 100%; width: 100%;
        margin: 0; padding: 0;
      } 
      #map{ 
        padding:0;
        border:solid 1px #343642;
        margin:5px 5px 5px 0px;
      }
      #leftPane{
        width:20%;
        border-top: solid 1px #343642;
        border-left: solid 1px #343642;
        border-bottom: solid 1px #343642;
        margin:5px 0px 5px 5px;
        color: #343642;
        font:100% Georgia,"Times New Roman",Times,serif;
        /*letter-spacing: 0.05em;*/
      }
     </style>
    <script src="Scripts/jquery-2.1.1.min.js"></script>
      <script src="Scripts/jquery-2.1.1.intellisense.js"></script>
      <script src="Scripts/jquery.validate.js"></script>
      <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
      <script src="Scripts/bootstrap.js"></script>
      <script src="Scripts/bootstrap-typeahead.js"></script>
    <script src="http://js.arcgis.com/3.11/"></script>
    <script>
        var map, locator, pointCollection;
        var coordenadasRuta = [];
        var featureLayerRuta = null;

        require([
          "esri/map", "esri/tasks/locator", "esri/graphic",
          "esri/InfoTemplate", "esri/symbols/SimpleMarkerSymbol",
          "esri/symbols/Font", "esri/symbols/TextSymbol",
          "dojo/_base/array", "esri/Color",
          "dojo/number", "dojo/parser", "dojo/dom", "dijit/registry",

          "dijit/form/Button", "dijit/form/Textarea",
          "dijit/layout/BorderContainer", "dijit/layout/ContentPane", "dojo/domReady!"
        ], function (
          Map, Locator, Graphic,
          InfoTemplate, SimpleMarkerSymbol,
          Font, TextSymbol,
          arrayUtils, Color,
          number, parser, dom, registry
        ) {
            parser.parse();

            map = new Map("map", {
                basemap: "streets",
                center: [-93.5, 41.431],
                zoom: 5
            });

            locator = new Locator("http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer");
            locator.on("address-to-locations-complete", showResults);

            // listen for button click then geocode
            registry.byId("locate").on("click", locate);
            

            map.infoWindow.resize(200, 125);

            function showResults(evt) {
                var symbol = new SimpleMarkerSymbol();
                var infoTemplate = new InfoTemplate(
                  "Location",
                  "Address: ${address}<br />Score: ${score}<br />Source locator: ${locatorName}"
                );
                symbol.setStyle(SimpleMarkerSymbol.STYLE_SQUARE);
                symbol.setColor(new Color([153, 0, 51, 0.75]));

                var geom;
                arrayUtils.every(evt.addresses, function (candidate) {
                    console.log(candidate.score);
                    if (candidate.score > 80) {
                        console.log(candidate.location);
                        var attributes = {
                            address: candidate.address,
                            score: candidate.score,
                            locatorName: candidate.attributes.Loc_name
                        };
                        geom = candidate.location;
                        var graphic = new Graphic(geom, symbol, attributes, infoTemplate);
                        //add a graphic to the map at the geocoded location
                        map.graphics.add(graphic);
                        //add a text symbol to the map listing the location of the matched address.
                        var displayText = candidate.address;
                        var font = new Font(
                          "16pt",
                          Font.STYLE_NORMAL,
                          Font.VARIANT_NORMAL,
                          Font.WEIGHT_BOLD,
                          "Helvetica"
                        );

                        var textSymbol = new TextSymbol(
                          displayText,
                          font,
                          new Color("#666633")
                        );
                        textSymbol.setOffset(0, 8);
                        map.graphics.add(new Graphic(geom, textSymbol));
                        return false; //break out of loop after one candidate with score greater  than 80 is found.
                    }
                });
                if (geom !== undefined) {
                    map.centerAndZoom(geom, 12);
                }
            }
        });
    </script>

    <script>
        function locate() {
            map.graphics.clear();
            var address = {
                "SingleLine": $("#address").val()
            };
            locator.outSpatialReference = map.spatialReference;
            var options = {
                address: address,
                maxLocations: 1,
                outFields: ["*"]
            };
            locator.addressToLocations(options).then(function (data) {
                console.log(data);
                coordenadasRuta.push([data[0]['attributes']['X'], data[0]['attributes']['Y']]);
                console.log(coordenadasRuta);
            });
        }

        $(document).ready(function () {
            $('#address').keyup(function () {
                sugerirCandidatos($(this).val());
            });
            $('#agregarLugar').click(function () {
                $('#stops').val($('#stops').val() + $('#address').val() + '\n');
                locate();
            });
            $("#ruta").click(function () {
                var lugares = $('#stops').val().toString().trim().split('\n');
                generarRuta();
            });
        });

        function prueba() {
            featureLayerRuta.setVisible(true);
        }

        function generarRuta() {
            var stops = '';
            for (var i in coordenadasRuta) {
                stops += i < coordenadasRuta.length - 1 ? coordenadasRuta[i][0] + ', ' + coordenadasRuta[i][1] + '; ' : coordenadasRuta[i][0] + ', ' + coordenadasRuta[i][1];
            }
            require(["esri/request"],
                function (esriRequest) {
                    var layerUrl = "http://route.arcgis.com/ArcGIS/rest/services/World/Route/NAServer/Route_World/solve";
                    var layersRequest = esriRequest({
                        url: layerUrl,
                        content: { token: 'a3VTA2te5KGTdXBB0nAbLr8EEFk5yIFIpcx9c06JB-_AciLaBhTmWcQYizqKN2VWVtsNn_p-gc3b6KVHPjHK3n-yu7cSZ-xft8fZH2i37YCwJit-3Xt0lHeIRiat53m6WdBNm-FQ4erjigKSQ8im0Q..', stops: stops, f: "json" },
                        handleAs: "json",
                        callbackParamName: "callback"
                    });
                    layersRequest.then(
                      function (data) {
                          console.log("Success: ", data);
                           
                          require(["esri/graphic"],
                              function (Graphic) {
                                  var lineas = [];
                                  for (i = 0; i < data['routes']['features'][0]['geometry']['paths'][0].length - 1; i++) {
                                      lineas.push([data['routes']['features'][0]['geometry']['paths'][0][i], data['routes']['features'][0]['geometry']['paths'][0][i + 1]])
                                  }
                                  var polilinea = { geometry: { paths: lineas, "spatialReference": { "wkid": 4326 } }, "symbol": { "color": [0, 255, 0, 255], "width": 5, "type": "esriSLS", "style": "esriSLSSolid" } };
                                  var gra = new Graphic(polilinea);
                                  map.graphics.add(gra);

                                  require(["esri/layers/FeatureLayer"],
                                      function (FeatureLayer) {
                                          featureLayerRuta = new FeatureLayer("http://sampleserver5.arcgisonline.com/ArcGIS/rest/services/LocalGovernment/Recreation/FeatureServer/1", {
                                              mode: FeatureLayer.MODE_ONDEMAND,
                                              outFields: ["*"]
                                          });
                                          featureLayerRuta.displayField = "notes SIG_JAPI";
                                          featureLayerRuta.applyEdits(data['routes']['features'][0], null, null, prueba);
                                      });
                                  /*
                                  var routeLayer = new esri.layers.FeatureLayer("http://sampleserver5.arcgisonline.com/ArcGIS/rest/services/LocalGovernment/Recreation/FeatureServer/1", {
                                      mode: esri.layers.FeatureLayer.MODE_ONDEMAND,
                                      outFields: ["*"]
                                  });
                                  //console.log("Success: ", routeLayer);
                                  //map.addLayers([routeLayer]);
                                  /*var res = data['candidates'];
        
                                  $.each(res, function (i, val) {
        
                                      $.each(val, function (k, v) {
                                          //  console.log(k + " : " + v + " -- " + k[v]);
                                          if (k == 'location') {
        
                                              for (var property in v) {
                                                  console.log('Prueba' + v['x'] + ': ' + v['y'] + '; ');
                                                  insertarCoordenadaRuta(v['x'], v['y']);
                                              }
                                          }
                                      });
                                     
                                  });*/

                              }, function (error) {
                                  console.log("Error: ", error.message);
                              });
                      });
                });


        }

        function sugerirCandidatos(texto) {
            if (texto.length > 0) {
                var params = { text: texto };
                locator.suggestLocations(params).then(function (suggestions) {
                    var sugerencias = [];
                    $.each(suggestions, function (i, val) {
                        sugerencias.push( val['text']);
                    });
                    console.log(sugerencias);
                    $('#address').autocomplete({
                        source: sugerencias
                    }).data("ui-autocomplete")._renderItem = function (ul, item) {
                        return $("<li>").data("item.autocomplete", item).append("<a>" + item.value + "</a>").appendTo(ul);
                    };
                    console.log(suggestions); //an array of suggestion objects.
                });
            }
        }

        function candidatos(textoEntrada) {
            var address = {
                "SingleLine": textoEntrada
            };
            locator.outSpatialReference = map.spatialReference;
            var options = {
                address: address,
                outFields: ["Loc_name"],
                countryCode: "US"
            };
            locator.addressToLocations(options).then(function (data) {
                console.log(data);
            });
        }
            /*require(["esri/request"],
                function (esriRequest) {
                    var addresses = { "records": [] };
                    for (var i = 0; i < textoEntrada.length; i++) {
                        addresses.records.push({
                            "attributes": {
                                "OBJECTID": i,
                                "SingleLine": textoEntrada[i]
                            }
                        });
                    }
                    var layerUrl = "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/geocodeAddresses";

                    var layersRequest = esriRequest({
                        url: 'http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/geocodeAddresses',
                        content: {
                            token: 'y4NOtwtUnyLDj-GJI8_CEKdt_S10PppORUku0S5zF24ye94T-82OKF8WXNsZvYqkhFF7inZ6GIOyCG7zLK4JMHw1H-D1vVmxM75mWU_DJQQJqMEyBuElRNTwcS7CeukjBiBX1Y6GPwVfWp2iW4Mc8A..',
                            addresses:{
                                "records": [
                                        {
                                            "attributes": {
                                                "OBJECTID": '1',
                                                "SingleLine": "380 New York St., Redlands, CA, 92373",
                                            }
                                        },
                                   {
                                       "attributes": {
                                           "OBJECTID": '2',
                                           "SingleLine": "1 World Way, Los Angeles, CA, 90045",
                                       }
                                   }
                                ]
                            },
                            f: "pjson"
                        },
                        handleAs: "json",
                        callbackParamName: "callback"
                    });
                    layersRequest.then(
                      function (data) {
                          console.log("Success: ", data);*/

                          //var $dd = $.parseJSON(data.response);
                          /*
                          for (var index in data) {
                              // you can show both index and value to know how the array is indexed in javascript (but it should be the same way it was in the php script)
                              alert("index:" + index + "\n value" + data['candidates']);

                          }*/
                          /*
                          var res = data['candidates'];

                          $.each(res, function (i, val) {

                              $.each(val, function (k, v) {
                                  //  console.log(k + " : " + v + " -- " + k[v]);
                                  if (k == 'location') {
                                     
                                      for (var property in v) {
                                          console.log('Prueba' + v['x'] + ': ' + v['y'] + '; ');
                                      }
                                  }
                              });
                             // console.log(k + " : " + v[k]);
                          });
                          insertarCoordenadaRuta('');
                          */
                          

                        /*  $(data).each(function (index, el) {
                             // alert();

                              $(el['candidates']).each(function (i, val) {
                                  $.each(val, function (k, v) {
                                      console.log(k + " : " + v);
                                  });
                              });

                          });


                        //  var oneval = $dd.filter('#candidates').text();
                         // alert($dd);
                         
                         console.log("Success: ", response);
                          var json = $.parseJSON(response);

                          $(json).each(function (i, val) {
                              $.each(val, function (k, v) {
                                  console.log(k + " : " + v);
                              });
                          });*/
                          /*
                      }, function (error) {
                          console.log("Error: ", error.message);
                      });
                });
        }*/

        </script>

  </head>
  <body class="claro">
    <div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" 
         data-dojo-props="design:'sidebar', gutters:false" 
         style="width:100%; height:100%;">

      <div id="leftPane"
           data-dojo-type="dijit/layout/ContentPane" 
           data-dojo-props="region:'left'">
        Enter an address then click the locate button to use a sample address locator to return the location for 
        street addresses in the United States. 
        <br>

        <!--<textarea id="address">380 New York St, Redlands</textArea>-->
        

        <button id="locate" type="button" class="btn btn-lg btn-primary" data-dojo-type="dijit/form/Button">Buscar</button>
         <br/>

        <input id="address" type="text" class="span3" style="margin: 0 auto;" data-provide="typeahead" data-items="4" 
               
              <!--data-source="[&quot;Alabama&quot;,&quot;Alaska&quot;,&quot;Arizona&quot;,&quot;Arkansas&quot;,&quot;California&quot;,&quot;Colorado&quot;,&quot;Connecticut&quot;,&quot;Delaware&quot;,&quot;Florida&quot;,&quot;Georgia&quot;,&quot;Hawaii&quot;,&quot;Idaho&quot;,&quot;Illinois&quot;,&quot;Indiana&quot;,&quot;Iowa&quot;,&quot;Kansas&quot;,&quot;Kentucky&quot;,&quot;Louisiana&quot;,&quot;Maine&quot;,&quot;Maryland&quot;,&quot;Massachusetts&quot;,&quot;Michigan&quot;,&quot;Minnesota&quot;,&quot;Mississippi&quot;,&quot;Missouri&quot;,&quot;Montana&quot;,&quot;Nebraska&quot;,&quot;Nevada&quot;,&quot;New Hampshire&quot;,&quot;New Jersey&quot;,&quot;New Mexico&quot;,&quot;New York&quot;,&quot;North Dakota&quot;,&quot;North Carolina&quot;,&quot;Ohio&quot;,&quot;Oklahoma&quot;,&quot;Oregon&quot;,&quot;Pennsylvania&quot;,&quot;Rhode Island&quot;,&quot;South Carolina&quot;,&quot;South Dakota&quot;,&quot;Tennessee&quot;,&quot;Texas&quot;,&quot;Utah&quot;,&quot;Vermont&quot;,&quot;Virginia&quot;,&quot;Washington&quot;,&quot;West Virginia&quot;,&quot;Wisconsin&quot;,&quot;Wyoming&quot;]">
         <!-- data-source ="candidatos('starbucks')" />-->
          
          <button id="agregarLugar" type="button">Agregar</button>
         <br/><br />

        <textarea id="stops" readonly="readonly">

        </textarea>
          <button id="ruta" type="button">Generar Ruta</button>
      </div>

      <div id="map" 
           data-dojo-type="dijit/layout/ContentPane" 
           data-dojo-props="region:'center'">
      </div>
    </div>
  </body>
</html>